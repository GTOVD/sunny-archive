name: Deployment Notification

on:
  deployment_status:

jobs:
  notify:
    if: github.event.deployment_status.state == 'failure' || github.event.deployment_status.state == 'error'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        uses: actions/github-script@v7
        with:
          script: |
            const discordWebhook = process.env.DISCORD_WEBHOOK;
            if (!discordWebhook) {
              console.log('DISCORD_WEBHOOK not set');
              return;
            }
            const state = context.payload.deployment_status.state;
            const targetUrl = context.payload.deployment_status.target_url;
            const repo = context.repo.owner + '/' + context.repo.repo;
            
            const message = {
              content: `ðŸš¨ **Deployment Failed** in \`${repo}\`\n**Status:** ${state}\n**Logs:** ${targetUrl}`,
            };

            await fetch(discordWebhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(message),
            });
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
